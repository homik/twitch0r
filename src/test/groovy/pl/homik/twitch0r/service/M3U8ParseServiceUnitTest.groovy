package pl.homik.twitch0r.service

import pl.homik.twitch0r.pojo.StreamInfo
import spock.lang.Specification

class M3U8ParseServiceUnitTest extends Specification {

    private M3U8ParseService service

    def setup() {
        service = new M3U8ParseService();
    }

    def "should parse m3u8file"() {
        given:
        def m3u8 = """#EXTM3U
            #EXT-X-TWITCH-INFO:NODE="video-edge-8bcab4.waw01",MANIFEST-NODE-TYPE="weaver_cluster",CLUSTER="waw01",SUPPRESS="false",SERVER-TIME="1529010912.51",TRANSCODESTACK="2017TranscodeX264_V2",USER-IP="31.11.128.77",SERVING-ID="f505a294c0c14cd789ad1de1e28bd78d",MANIFEST-NODE="video-weaver.waw01",ABS="false",BROADCAST-ID="29091157568",STREAM-TIME="3428.51338196",MANIFEST-CLUSTER="waw01"
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="chunked",NAME="720p60 (source)",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=3537762,RESOLUTION=1280x720,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="chunked"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpcDR4p7lqT72yL9h7ZRlMx8wvCMI8vQpY-pFV8CHATf9p0u3KOvYBTDF9JqCbk9fm3oOunG1nWnDj_3yBm3Y4eWIX9HJLnrl59_nSwV_jXkpnNszwDe-h2ne84hKTvag-oKslfMxqiBG71kFshdGo68nPX95WUjfB2PtnPEc1uhVVM_IsyiNZyHJpYiDBpv5q4nWACEOnxZoVIHae_3yQaUfETaDtQ3L7CTFkjBgwlbF1rpkphhy0UnzrL3SESj_t9lRpeX8eonbV7dnA-Pzm57xY4cvxvPUWP3DqTxMT5jwTZ7Y67Qk1fj1oQiyP85vMQuSoBSXaVYNhPM5GvIGT_QvV0Fa2u48zdl-J899LSAx51TTiqEBX-7te1jesI9XI_MKOEOmmMGKY1vHqu_tUSwJhMqY2Sj7NMSy_2Fad19ui2MOMIupf1-LQ4ysXW1m9RzKWeQ8RBdC2B4AikwoiAJWT3-PC2zRirKqassdVP0OF9Ws_OkDl0awDcvavR3uczDSIOg5RPYENJ9ZBU1_Om2UQzRYU06UxcSEPCZYIDrWfMwP2FL7DsJTGAaDFDr9bYzk9Smmm5IaA.m3u8
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p60",NAME="720p60",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=3390947,RESOLUTION=1280x720,CODECS="avc1.77.31,mp4a.40.2",VIDEO="720p60"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDMhNPLr5Qt1qynoKp2xcmlHqZFsGl43xQBB6cOo3msNCFPTTlkNGwGhK80Tf5he1WYBr89HbS1WFjX9AIQhdY7J7g-VzN7PmnP7vUY_FD3xsVPbPzjZIhHyloeJz63xk3BDpyTvVXzqzMd8INUF6oe3gq5NVbB8gQCuY2UgECACgHXIWssbVbZyiAqfDM-dldYxdmI34VyyUFHvG-1cqnS7XCOOb2GTeeFKguQgvbS4bO58Jcb298cY5naGmxxwcOgbXLfPzdYO6xXEmqSp36WbYC7iempL6wCxIkc8wmWxmbVnIq35cho_kL0f90A_YMiimS48MjP3yrwJlw-JMmx7kQZHiqB7fdXKjuoYf3sf_KnJuCFVeF3hsctLt7VYQK4OVaaYlA01RadSpa_dMrJnKpwr-5OloaeqI9JqFbvG4yyopPEbKhWsxpt_gj20V8oO87-AwdpAK_zlZx2RTn8a6dsgBFNeJ6JLmE_KqOsPWGMahveUICscylFPKvCborPauvm1LofGbwuH7Xa1BxPzwHlUNFEhC9EluPEfvkfYcHO4oT33-6GgzPdUI3JSgm_FovY9Y.m3u8
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p30",NAME="720p",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2340947,RESOLUTION=1280x720,CODECS="avc1.77.31,mp4a.40.2",VIDEO="720p30"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDV59WpdyXfF63qZkM6eOqiNOtrG8qhUXNV4ePLyawiTxo9X8x6cTqoiYPJO5fU74qCBnm4MlxRbKOo8HvXB3dyuunDwH7zvj7DxoFXHAMZxQWtmj3Qup2MDM15O3L8CSYY-vZxgV6OwRzjjt8qydfCmBHAApE_sAFb_aL5cFmoUFJcT939KdG_9ysu3MgRW5nrESRhIZHk6kxnBG7KHh0tlihOh_ud3Vyn-2zLhzWbSZq2yfIPJhEdWjA12p5iefSBMw38VWpEhFB4DDod4kmU2egkb8rjjZ9gCpqIvn0HQGGp6qfZpb1wzUFI52EzOl3PLkInE43Ix0qfd-u204UBBYeqexn1MGpox3J0CSQmHEBnfoftgTR8_O5xVeWwxF7RP7tOdn8PX9tKavuxpbWdOeSG-6a7x3zMElVs0oLyD1ayfx408sAU1EtdM9yhG0599RONAPutDACM-vM58YU4xzhg3KtlzZJSqy1e9S4b20RqS5ewOZUKy7-b-ibiZHLD-4CJn6o28PwGw1PpnapLV0M6dp9EhC84ah3OoFiW6HTkR5RZbZoGgzIfLNy3d0fiY-uv14.m3u8
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="480p30",NAME="480p",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1395947,RESOLUTION=852x480,CODECS="avc1.77.31,mp4a.40.2",VIDEO="480p30"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDHuXwgkOfVbGEHVi4TJ9CxRqsEjxwkk2HnJbgdHHmjeVLEgPbhbmSyDwiTbpQa4mn7_afHI4pKchcbIU_7gFB7XauQ1iEqhThNX2LqPAUxcm-oISVZ9K1SKx8vPTcuAU4su_2sz-DYjrwfUaaDBPzCNQJppw-5cKM7IPP6ZYFTzDgZUOrmShhyRPokKLoSBgHsYUshnJ-WDJsiZAFRd2BNrw4R1VruusGzvE_JIoBVprwMEMCcDaO2QiWhcebTa10P2qfB3I3SgVSspiVS-kWc795_DLeQ0SBnHOS4b4GBHz0xIN8SJzpfwf8M_6hiYyr3gUTW2YUDipI9iSSFiJIXUSAX_Aora0kwrGc2MyJCInQOf7oub7u5ccImehlZ8D0pCDghOm1pTStVp0Ez5oaorEGr6KxUfRrnJxTs8tAaowe3-oF6iVKR9ntSTt1nooz1u9r1ZVWPafWLUDxI7pQwdXRF2Oxso7QPavqaR2Xb1PMCpVJIXtnMO8R5QHa8dUaSpbv1w_5In9_lnfc1Lig7OQUOSsiEhDpXIPPzHcI_Ew-orY4C4JTGgyXF0ijMEJ1ktfGtBY.m3u8
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="360p30",NAME="360p",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=630000,RESOLUTION=640x360,CODECS="avc1.77.31,mp4a.40.2",VIDEO="360p30"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUD0Vo25m7BuVTuD2PJF_5lflRbxBjyF8lRlJbYUoU19PgShaX2c-Cc85Zf7RoxjE48oVG73qM9gBwT5LuVse8reNIL6HR8a41h2C9Dg1CxNJHMoFmp3OUXZEICJg0YyxnZUCl9LKVIppCKwhKhGmSIpvWnQpyC1EytBgLcSKujI9dNPI2AyvL6ppUgrlFPUII9_gEKnz_QQm7LqSi_WcT8JCD3lv4kPBKFs4ttU18zMfC44eqhvGOfBDhPOIHdiQvUKdr5zn3XXbZ6N1DqaR9E4_wgahPYAiDfFecdtlhr9sPn44b9GZ0MPNpyCVvRofWTNteLWc1_ZG-cbE4n5CT7qcU6gLqJZbhFPvu4dXOJVk6lnWyuuV7qx9MArJ1XvQVbLMTfJbuB8jpn3-jGNyVjFJdI_58WCDmlWKmeWTmmF1kT3DlVzeDPCBdA5yDPmqzjTI_oobuzECPGAojtZ92yNT68R2Ot7ywmDWKVUQpUbXMiMgqAlQjNyKc7CGtZZD6DetJb0psbwsbUcxqz9HZftivP3y-UEhAGazmp1s_Ecw82Rft7i2NCGgxPve8oicgXRGytB4w.m3u8
            #EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="160p30",NAME="160p",AUTOSELECT=YES,DEFAULT=YES
            #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=230000,RESOLUTION=284x160,CODECS="avc1.77.31,mp4a.40.2",VIDEO="160p30"
            http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDPyj-fZzrHOIq9afQ9pjsR3spt6HCykO8-ccUFljexGFGed58TfJFrXcMNA2xw6JI5536knMdjh3HxmOL58CQBmRSw_jPxaz-1GGs9rTkbrBZxU3nL1EsHuzDqkpqy7uXXwgMdyKNNBzFVmivhMwZZ9UKNQ9rF2T4P2izRm-Du6D8q3_O20Vx0rqzvMX2QLrPHqCNsuPmpeB24WLl1MmYp0al-LuozJyfDA0EJdQrIAOV0c5ntpzJNa5Z-IKvXlKYXElfN9pvVYGF5egxUeICvFJnqUzVrw200l1Ci4VLPjAHb3Ff0URZbLQMzM31-StZGdvq1hQjSEJiz5bqhCElVfkCzVEaIL_29mrbX0VxeAcpFiRtHq3_5PgoIYXGQO2remCbQghtKXDYm6vyXYqtnNZ69_2scYe4v6qssLRmBvstocymB3i8wuvDoHExeIVQ07JMqldK1LWYJljcwAw_d9onC49Pu3DdCKpEvJP1zXE5a2s6zof5A4aGwtqhiz-4zCp_DDLpEcG8QgM0iD4_XYGkZcWJEhChfr_OpexcoTPAPE-CbATGGgxXvyhq-wyU0FFaiOw.m3u8"""
        when:
        def result = service.getStreamInfoFromM3U8(m3u8)
        then:
        def expected = [new StreamInfo("720p60 (source)", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpcDR4p7lqT72yL9h7ZRlMx8wvCMI8vQpY-pFV8CHATf9p0u3KOvYBTDF9JqCbk9fm3oOunG1nWnDj_3yBm3Y4eWIX9HJLnrl59_nSwV_jXkpnNszwDe-h2ne84hKTvag-oKslfMxqiBG71kFshdGo68nPX95WUjfB2PtnPEc1uhVVM_IsyiNZyHJpYiDBpv5q4nWACEOnxZoVIHae_3yQaUfETaDtQ3L7CTFkjBgwlbF1rpkphhy0UnzrL3SESj_t9lRpeX8eonbV7dnA-Pzm57xY4cvxvPUWP3DqTxMT5jwTZ7Y67Qk1fj1oQiyP85vMQuSoBSXaVYNhPM5GvIGT_QvV0Fa2u48zdl-J899LSAx51TTiqEBX-7te1jesI9XI_MKOEOmmMGKY1vHqu_tUSwJhMqY2Sj7NMSy_2Fad19ui2MOMIupf1-LQ4ysXW1m9RzKWeQ8RBdC2B4AikwoiAJWT3-PC2zRirKqassdVP0OF9Ws_OkDl0awDcvavR3uczDSIOg5RPYENJ9ZBU1_Om2UQzRYU06UxcSEPCZYIDrWfMwP2FL7DsJTGAaDFDr9bYzk9Smmm5IaA.m3u8"),
                        new StreamInfo("720p60", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDMhNPLr5Qt1qynoKp2xcmlHqZFsGl43xQBB6cOo3msNCFPTTlkNGwGhK80Tf5he1WYBr89HbS1WFjX9AIQhdY7J7g-VzN7PmnP7vUY_FD3xsVPbPzjZIhHyloeJz63xk3BDpyTvVXzqzMd8INUF6oe3gq5NVbB8gQCuY2UgECACgHXIWssbVbZyiAqfDM-dldYxdmI34VyyUFHvG-1cqnS7XCOOb2GTeeFKguQgvbS4bO58Jcb298cY5naGmxxwcOgbXLfPzdYO6xXEmqSp36WbYC7iempL6wCxIkc8wmWxmbVnIq35cho_kL0f90A_YMiimS48MjP3yrwJlw-JMmx7kQZHiqB7fdXKjuoYf3sf_KnJuCFVeF3hsctLt7VYQK4OVaaYlA01RadSpa_dMrJnKpwr-5OloaeqI9JqFbvG4yyopPEbKhWsxpt_gj20V8oO87-AwdpAK_zlZx2RTn8a6dsgBFNeJ6JLmE_KqOsPWGMahveUICscylFPKvCborPauvm1LofGbwuH7Xa1BxPzwHlUNFEhC9EluPEfvkfYcHO4oT33-6GgzPdUI3JSgm_FovY9Y.m3u8"),
                        new StreamInfo("720p", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDV59WpdyXfF63qZkM6eOqiNOtrG8qhUXNV4ePLyawiTxo9X8x6cTqoiYPJO5fU74qCBnm4MlxRbKOo8HvXB3dyuunDwH7zvj7DxoFXHAMZxQWtmj3Qup2MDM15O3L8CSYY-vZxgV6OwRzjjt8qydfCmBHAApE_sAFb_aL5cFmoUFJcT939KdG_9ysu3MgRW5nrESRhIZHk6kxnBG7KHh0tlihOh_ud3Vyn-2zLhzWbSZq2yfIPJhEdWjA12p5iefSBMw38VWpEhFB4DDod4kmU2egkb8rjjZ9gCpqIvn0HQGGp6qfZpb1wzUFI52EzOl3PLkInE43Ix0qfd-u204UBBYeqexn1MGpox3J0CSQmHEBnfoftgTR8_O5xVeWwxF7RP7tOdn8PX9tKavuxpbWdOeSG-6a7x3zMElVs0oLyD1ayfx408sAU1EtdM9yhG0599RONAPutDACM-vM58YU4xzhg3KtlzZJSqy1e9S4b20RqS5ewOZUKy7-b-ibiZHLD-4CJn6o28PwGw1PpnapLV0M6dp9EhC84ah3OoFiW6HTkR5RZbZoGgzIfLNy3d0fiY-uv14.m3u8"),
                        new StreamInfo("480p", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDHuXwgkOfVbGEHVi4TJ9CxRqsEjxwkk2HnJbgdHHmjeVLEgPbhbmSyDwiTbpQa4mn7_afHI4pKchcbIU_7gFB7XauQ1iEqhThNX2LqPAUxcm-oISVZ9K1SKx8vPTcuAU4su_2sz-DYjrwfUaaDBPzCNQJppw-5cKM7IPP6ZYFTzDgZUOrmShhyRPokKLoSBgHsYUshnJ-WDJsiZAFRd2BNrw4R1VruusGzvE_JIoBVprwMEMCcDaO2QiWhcebTa10P2qfB3I3SgVSspiVS-kWc795_DLeQ0SBnHOS4b4GBHz0xIN8SJzpfwf8M_6hiYyr3gUTW2YUDipI9iSSFiJIXUSAX_Aora0kwrGc2MyJCInQOf7oub7u5ccImehlZ8D0pCDghOm1pTStVp0Ez5oaorEGr6KxUfRrnJxTs8tAaowe3-oF6iVKR9ntSTt1nooz1u9r1ZVWPafWLUDxI7pQwdXRF2Oxso7QPavqaR2Xb1PMCpVJIXtnMO8R5QHa8dUaSpbv1w_5In9_lnfc1Lig7OQUOSsiEhDpXIPPzHcI_Ew-orY4C4JTGgyXF0ijMEJ1ktfGtBY.m3u8"),
                        new StreamInfo("360p)", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUD0Vo25m7BuVTuD2PJF_5lflRbxBjyF8lRlJbYUoU19PgShaX2c-Cc85Zf7RoxjE48oVG73qM9gBwT5LuVse8reNIL6HR8a41h2C9Dg1CxNJHMoFmp3OUXZEICJg0YyxnZUCl9LKVIppCKwhKhGmSIpvWnQpyC1EytBgLcSKujI9dNPI2AyvL6ppUgrlFPUII9_gEKnz_QQm7LqSi_WcT8JCD3lv4kPBKFs4ttU18zMfC44eqhvGOfBDhPOIHdiQvUKdr5zn3XXbZ6N1DqaR9E4_wgahPYAiDfFecdtlhr9sPn44b9GZ0MPNpyCVvRofWTNteLWc1_ZG-cbE4n5CT7qcU6gLqJZbhFPvu4dXOJVk6lnWyuuV7qx9MArJ1XvQVbLMTfJbuB8jpn3-jGNyVjFJdI_58WCDmlWKmeWTmmF1kT3DlVzeDPCBdA5yDPmqzjTI_oobuzECPGAojtZ92yNT68R2Ot7ywmDWKVUQpUbXMiMgqAlQjNyKc7CGtZZD6DetJb0psbwsbUcxqz9HZftivP3y-UEhAGazmp1s_Ecw82Rft7i2NCGgxPve8oicgXRGytB4w.m3u8"),
                        new StreamInfo("160p", "http://video-weaver.waw01.hls.ttvnw.net/v1/playlist/CpUDPyj-fZzrHOIq9afQ9pjsR3spt6HCykO8-ccUFljexGFGed58TfJFrXcMNA2xw6JI5536knMdjh3HxmOL58CQBmRSw_jPxaz-1GGs9rTkbrBZxU3nL1EsHuzDqkpqy7uXXwgMdyKNNBzFVmivhMwZZ9UKNQ9rF2T4P2izRm-Du6D8q3_O20Vx0rqzvMX2QLrPHqCNsuPmpeB24WLl1MmYp0al-LuozJyfDA0EJdQrIAOV0c5ntpzJNa5Z-IKvXlKYXElfN9pvVYGF5egxUeICvFJnqUzVrw200l1Ci4VLPjAHb3Ff0URZbLQMzM31-StZGdvq1hQjSEJiz5bqhCElVfkCzVEaIL_29mrbX0VxeAcpFiRtHq3_5PgoIYXGQO2remCbQghtKXDYm6vyXYqtnNZ69_2scYe4v6qssLRmBvstocymB3i8wuvDoHExeIVQ07JMqldK1LWYJljcwAw_d9onC49Pu3DdCKpEvJP1zXE5a2s6zof5A4aGwtqhiz-4zCp_DDLpEcG8QgM0iD4_XYGkZcWJEhChfr_OpexcoTPAPE-CbATGGgxXvyhq-wyU0FFaiOw.m3u8")] as List<StreamInfo>

        result == expected


    }
}
